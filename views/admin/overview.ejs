<div class="text-3xl font-bold pb-8">
    Adminland
</div>

<div class="grid grid-cols-2 gap-6">

    <div class="shadow-xl p-6 rounded-md">
        <span class="text-2xl font-bold">
            Users üë§
        </span>

        <table id="user_table" class="stripe">
            <thead>
                <tr>
                    <th>
                        Name
                    </th>
                    <th>
                        Role
                    </th>
                    <th>
                        Section
                    </th>
                </tr>
            </thead>

            <tbody>
            <% for (const siteUser of users) { %>
                <% if (siteUser.id === user.id) continue; %>
                <tr>
                    <td>
                        <%= siteUser.name %>
                    </td>
                    <td>
                        <form action="admin/changeRole" method="post">
                            <input type="hidden" value="<%= siteUser.id %>" name="userId">
                            <select required name="role" onchange="submit(this);" class="form-select appearance-none
                                  block
                                  w-full
                                  py-1.5
                                  mb-3
                                  text-base
                                  font-normal
                                  text-gray-700
                                  bg-white bg-clip-padding bg-no-repeat
                                  border border-solid border-gray-300
                                  rounded
                                  transition
                                  ease-in-out
                                  m-0
                                  focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none">
                                <option value="STUDENT" <% if (siteUser.role === 'STUDENT') { %> selected <% } %>>
                                    Student
                                </option>
                                <option value="INSTRUCTOR" <% if (siteUser.role === 'INSTRUCTOR') { %> selected <% } %>>
                                    Instructor
                                </option>
                                <option value="ADMIN" <% if (siteUser.role === 'ADMIN') { %> selected <% } %>>
                                    Admin
                                </option>
                            </select>
                        </form>
                    </td>
                    <td>
                        <% if (siteUser.role === 'STUDENT') { %>
                            <form action="admin/changeSection" method="post">
                                <input type="hidden" value="<%= siteUser.id %>" name="userId">
                                <select required name="section" onchange="submit(this);" class="form-select appearance-none
                                      block
                                      w-full
                                      py-1.5
                                      mb-3
                                      text-base
                                      font-normal
                                      text-gray-700
                                      bg-white bg-clip-padding bg-no-repeat
                                      border border-solid border-gray-300
                                      rounded
                                      transition
                                      ease-in-out
                                      m-0
                                      focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none">
                                    <% for (const section of sections) { %>
                                        <option value="<%= section.id %>" <% if (siteUser.sectionId === section.id) { %> selected <% } %>>
                                            <%= section.name %>
                                        </option>
                                    <% } %>
                                </select>
                            </form>
                        <% } %>
                    </td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>

    <div class="shadow-xl p-6 rounded-md">
        <span class="text-2xl font-bold">
            Shifts requesting deletion üö´
        </span>

        <table id="shift_delete_table" class="stripe">
            <thead>
                <tr>
                    <th>
                        Student
                    </th>
                    <th>
                        Date
                    </th>
                    <th>
                        Site
                    </th>
                    <th>
                        Action
                    </th>
                </tr>
            </thead>

            <tbody>
            <% for (const shift of shifts) { %>
                <tr>
                    <td>
                        <%= shift.user.name %>
                    </td>
                    <td>
                        <%= shift.date.toDateString() %>
                    </td>
                    <td>
                        <%= shift.site.name %>
                    </td>
                    <td>
                        <button title="Approve" onclick="window.location = 'admin/approveShiftDelete/<%= shift.id %>'" class="bg-gray-50 hover:bg-blue-100  border py-1.5 px-4 rounded">
                            <svg   class="ml-auto fill-current justify-self-end text-gray-500 w-5 h-5 cursor-pointer"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18">
                                <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                            </svg>
                        </button>
                        <button title="Decline" onclick="window.location = 'admin/declineShiftDelete/<%= shift.id %>'" class="bg-red-500 hover:bg-red-400 border py-1.5 px-4 rounded">
                            <svg 
                            class="ml-auto fill-current justify-self-end text-white w-5 h-5 cursor-pointer"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>

    <div class="shadow-xl p-6 rounded-md">
        <span class="text-2xl font-bold">
            Sites üè¢
        </span>

        <div class="flex justify-end pt-2.5">
            <a href="/addSite" class="bg-blue-500 hover:bg-blue-400 text-white text-center font-semibold py-1.5 px-4 hover:border-blue-500 rounded">Add Site</a>
        </div>

        <table id="site_table" class="stripe">
            <thead>
            <tr>
                <th class="dark:text-white">
                    Site Name
                </th>
                <th class="dark:text-white">
                    Delete
                </th>
            </tr>
            </thead>

            <tbody>
            <% for (const site of sites) { %>
                <% if (site.status !== 'DELETED') { %>
                <tr>
                    <td>
                        <%= site.name %>
                    </td>
                    <td class="flex">
                        <button title="Delete" onclick="deleteModal(<%= site.id %>)" class="bg-red-500 hover:bg-red-400 border py-1.5 px-4 rounded">
                            <svg 
                            class="ml-auto fill-current justify-self-end text-white w-5 h-5 cursor-pointer"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18">
                           <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"/>
                            </svg>
                        </button>
                    </td>
                </tr>
                <% } %>
            <% } %>
            </tbody>

        </table>

    </div>

    <div class="shadow-xl p-6 rounded-md">
        <span class="text-2xl font-bold">
            Sections üë•
        </span>
        <div class="flex justify-end pt-2.5 pb-2.5">
            <button onclick="addSectionModal()" class="bg-blue-500 hover:bg-blue-400 text-white text-center font-semibold py-1.5 px-4 hover:border-blue-500 rounded">Add Section</button>
        </div>
        <table id="section_table" class="stripe">
            <thead>
                <tr>
                    <th>
                        Name
                    </th>
                    <th>
                        Instructor
                    </th>
                    <th>
                        Delete
                    </th>
                </tr>
            </thead>

            <tbody>
            <% for (const section of sections) { %>
                <% if (section.id === 1) continue; %>
                <tr>
                    <td>
                        <%= section.name %>
                    </td>
                    <td>
                        <form action="admin/changeSectionInstructor" method="post">
                            <input type="hidden" value="<%= section.id %>" name="sectionId">
                            <select required name="instructor" onchange="submit(this);" class="form-select appearance-none
                                  block
                                  w-full
                                  py-1.5
                                  mb-3
                                  text-base
                                  font-normal
                                  text-gray-700
                                  bg-white bg-clip-padding bg-no-repeat
                                  border border-solid border-gray-300
                                  rounded
                                  transition
                                  ease-in-out
                                  m-0
                                  focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none">
                                <% for (const siteUser of users) { %>
                                    <% if (siteUser.role === 'INSTRUCTOR' || siteUser.role === 'ADMIN') { %>
                                        <option value="<%= siteUser.id %>" <% if (section.instructorId === siteUser.id) { %> selected <% } %>>
                                            <%= siteUser.name %>
                                        </option>
                                    <% } %>
                                <% } %>
                            </select>
                        </form>
                    </td>
                    <td>
                    </td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>
</div>

<dialog id="deleteSite" class="bg-transparent z-1 relative w-screen h-screen">
    <div class="p-7 flex justify-center items-center fixed left-0 top-0 w-full h-full bg-gray-900 bg-opacity-50 z-50 transition-opacity duration-200 opacity-0">
        <div class="bg-white rounded-lg w-fit relative">
            <div class="flex flex-col items-start">
                <!-- Top of modal -->
                <div class="px-7 pt-7 flex flex-row items-center w-full">
                    <!-- Title -->
                    <div class="text-gray-900 font-bold text-lg">Delete Site Confirmation
                    </div>
                    <!-- X button -->
                    <svg onclick="modalClose('deleteSite')"
                         class="ml-auto fill-current justify-self-end text-gray-700 w-5 h-5 cursor-pointer"
                         xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"/>
                    </svg>
                </div>
                <div class="px-7 pb-3 flex justify-start items-center w-full">
                    <p class="whitespace-pre-line text-gray-500">
                        Are you sure you want to delete this site?
                        All the shifts associated with this site will be removed
                    </p>
                </div>
                <!-- Beginning of Form content -->
                <form id="deleteForm" method="POST">
                </form>
                <!-- Bottom of modal -->
                <div class="px-7 pt-1 pb-7 flex justify-start items-center w-full">
                    <button id="deleteButton" form="deleteForm" type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent
                    shadow-sm px-4 py-2 bg-red-500 text-base font-medium text-white hover:bg-red-400 focus:outline-none
                    focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:w-auto sm:text-sm">
                        Delete
                    </button>
                    <button type="button" onclick="modalClose('deleteSite')" class=" w-full inline-flex justify-center rounded-md border border-gray-300
                    shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-100 focus:outline-none
                    focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</dialog>


<dialog id="addSectionModal" class="bg-transparent z-1 relative w-screen h-screen">
    <div class="p-7 flex justify-center items-center fixed left-0 top-0 w-full h-full bg-gray-900 bg-opacity-50 z-50 transition-opacity duration-200 opacity-0">
        <div class="bg-white rounded-lg w-fit relative">
            <div class="flex flex-col items-start">
                <!-- Top of modal -->
                <div class="p-7 flex flex-row items-center w-full">
                    <!-- Title -->
                    <div class="text-gray-900 font-bold text-lg">Add a Section</div>
                    <!-- X button -->
                    <svg onclick="modalClose('addSectionModal')"
                         class="ml-auto fill-current justify-self-end text-gray-700 w-5 h-5 cursor-pointer"
                         xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"/>
                    </svg>
                </div>

                <!-- Beginning of Form content -->
                <form id="addSectionForm" action="admin/addSection" method="POST" class="px-7 overflow-x-hidden overflow-y-auto"
                      style="max-height: 40vh;">
                    <div class="flex flex-col">
                        <label class="text-gray-800" for="sectionName">Section Name:</label>
                        <input class="rounded" type="text" id="sectionName" name="sectionName" value="">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-gray-800 pt-3" for="sectionInstructor">Section Instructor:</label>
                        <select required name="sectionInstructor" id="sectionInstructor"  class="form-select appearance-none
                        block
                        w-full
                        py-1.5
                        mb-3
                        text-base
                        font-normal
                        text-gray-700
                        bg-white bg-clip-padding bg-no-repeat
                        border border-solid border-gray-300
                        rounded
                        transition
                        ease-in-out
                        m-0
                        focus:text-gray-700 focus:bg-white focus:border-blue-600 focus:outline-none">
                            <!-- Check if instructor is already in charge of a section -->
                            <% const existingInstructors = []; %>
                            <% for (const section of sections) { %>
                                <% existingInstructors.push(section.instructorId); %>
                            <% } %>

                            <% for (const section of sections) { %>
                                <% if (section.id === 1) continue; %>
                                    <% for (const siteUser of users) { %>
                                        <% if ((siteUser.role === 'INSTRUCTOR' || siteUser.role === 'ADMIN') && !(existingInstructors.includes(siteUser.id))) { %>
                                            <option value="<%= siteUser.id %>" <% if (section.instructorId === siteUser.id) { %> selected <% } %>>
                                                <%= siteUser.name %>
                                            </option>
                                        <% } %>
                                    <% } %>
                                <% } %>
                        </select>
                    </div>
                </form>
                <!-- Bottom of modal -->
                <div class="px-7 pb-7 pt-2.5 flex justify-start items-center w-full">
                    <input type="submit" form="addSectionForm" value="Add Section"
                           class="save-button bg-blue-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded mr-3">
                    <button type="button" onclick="modalClose('addSectionModal')"
                            class=" hover:bg-gray-500 text-gray-700 font-semibold hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent focus:outline-none rounded">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</dialog>

<script>

    function openModal(key) {
        document.getElementById(key).style.display = "block";
        document.getElementById(key).children[0].scrollTop = 0;
        document.getElementById(key).children[0].classList.remove('opacity-0');
        document.getElementById(key).children[0].classList.add('opacity-100')
        
    }

    function modalClose(key) {
        document.getElementById(key).children[0].classList.remove('opacity-100');
        document.getElementById(key).children[0].classList.add('opacity-0');
        setTimeout(function () {
            document.getElementById(key).style.display = "none";
            document.body.removeAttribute('style');
        }, 100);
    }

    function deleteModal(siteID) {
        openModal('deleteSite')
        document.getElementById('deleteForm').setAttribute('action', action=`/admin/siteDelete/${siteID}`)
    }

    function addSectionModal() {
        openModal('addSectionModal')
    }

    submit = (select) => {
        const form = select.form;
        form.submit();
    }

    $(document).ready(() => {
        $('#user_table').DataTable({
            lengthChange: false,
            columnDefs: [
                {
                    searchable: false,
                    sortable: false,
                    targets: [1, 2]
                },
            ],
        });

        $('#section_table').DataTable({
            lengthChange: false,
            paging: false,
            columnDefs: [
                {
                    searchable: false,
                    sortable: false,
                    targets: [1, 2]
                },
            ],
        });

        $('#shift_delete_table').DataTable({
            lengthChange: false,
            columnDefs: [
                {
                    searchable: false,
                    sortable: false,
                    targets: [2, 3]
                },
            ],
        });

        $('#site_table').DataTable({
            lengthChange: false,
            paging: false,
            searching: false,
            columnDefs: [
                {
                    sortable: false,
                    targets: [1]
                },
            ],
        });

    });
</script>
